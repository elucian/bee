<html><head>
  <meta charset="utf-8">
  <meta name="description" content="Introduction to coroutines in Bee language.">
  <meta name="author" content="Elucian Moise">
  <meta name="keywords" content="sage, code, bee, coroutine, syntax">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Website title -->
  <title>Bee Coroutines</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <!-- Icon -->
  <link rel="icon" type="image/png"  href="../images/favicon.ico">
  <!-- Bee Highlighter -->
  <script src="bee.js"></script>
  <!-- Sage-Code CSS -->
  <link rel="stylesheet" href="../sage.css">
  </head>
<body onload="bee_render()">
<div class="container">

<!-- header -->
<div class="row">
    <div class="col">
        <a href="https://sagecode.net"><img src="../images/sage-logo.svg" alt="Sage-Code Laboratory" height="80"/></a>
    </div>
    <div class="col  bottom-right">
        <a href="index.html#lang-index" rel="nofollow">index</a>&lt;--
    </div>
</div><hr>

<h1>Bee Coroutines</h1>
<div class="alert alert-secondary shadow-sm">
Bee is designed for high performance computing using multi-core processors. There is a second resource for concurency: high performance video cards or add-in cards that enable parallel processing. After we finish the design, we will research hardware sollutions to optimize de compiler.
</div>

<h2><a id="coroutines"></a>Coroutines</h2>

<p>Coroutines are rules that can be suspended with all states ready then resumed on demand multiple times. Each time we resume a coroutine this can produce one result that we capture. So a coroutine can produce multiple results until finishes.</p>

<h4>Example:</h4>

<p>Coroutines can be used as a <em>branch</em> of main thread. This is not yet running in parallel but is an example for how a rule can play as a coroutine.</p>

<ul>
<li>you need only one coroutine to create a side branch,</li>
<li>call a branch using <em>start</em> keyword and suspended using <em> yield</em> keyword,</li>
<li>resume a coroutine using <em>yield</em> plus routine name.</li>
</ul>

<pre><code class="language-bee">
rule test(n &isin; N) =&gt; (result &isin; N):
  ** can generate n numbers
  for &forall; i &isin; (1..n) do
    result := i;
    ** suspend execution
    yield; -- wait for the main thread
  repeat;
  result = 0; -- finalization signal
return;

** start secondary process
dtart test(9) -- initialize coroutine
begin: 
  r &isin; N;  -- result reference
do
  yield r &lt;- test;  -- capture next result
  write (r, ",");
repeat if r &gt; 0;

print;  -- 0,1,2,3,4,5,6,7,8,9,
</code></pre>

<p><b>Note:&amp;</b>In the example above, the program is still working in serial mode, except that has a branch running on a separated thread. When the coroutine function the main thread is on hold, and when the main thread function the coroutine is waiting.</p>

<h2><a id="producer-consumer">Producer consumer</h4>

<p>Producer consumer pattern is using coroutines that can work in parallel in asynchronous mode. That means we start coroutines and do not wait to finish but let the main thread to continue. A producer is preparing the work and the consumer is doing the work.</p>

<p>If you do not know how this works, take a look to the diagram below. We have one rule called "producer" one list that act as queue and a routine called "consumer". The queue has a limited capacity. We can use same consumer twice, if we do then the application is also multi-threading.</p>.

<div align="center">
  <img src="img/producer-consumer.svg" alt="producer-consumer" width="520" class="img-fluid protect rounded shadow border" >
  <p>Producer Consumer <br/>Diagram</p>
</div>

<h4>Notes:</h4>

<ul>
<li>for this you need two rules: one is producer and other is consumer,</li>
<li>the main thread is starting threads using <em>begin</em> ,</li>
<li>producer is a dispatcher that distribute the work,</li>
<li>producer is usually working on a single thread;</li>
<li>consumer is a worker that resolve a task given by the producer;</li>
<li>consumer is usually working on multiple threads;</li>
</ul>

<h4>Example:</h4>

<div class="alert alert-warning"><span style="color:brown">Info:&nbsp;</span>This example is complex so we have chosen to keep it on GitHub with the Bee project. If you want to visualize it you need Notepad++ and color syntax highlighter. Go back to index page and follow the instructions at the bottom of the page.</div>

<p><b>Read more:</b>
<a href="graphics.html">Graphics</a></p>
<!-- Footer -->
<footer class="footer">
  <div class="footer-copyright text-center"></div>
</footer>
</div>
</body>
</html>